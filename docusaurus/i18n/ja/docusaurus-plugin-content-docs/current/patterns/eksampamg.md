# EKS での AWS オープンソースサービスを使ったモニタリング
<!-- Node Exporter、Amazon Managed Prometheus、Grafana による可視化
-->
コンテナ化されたアプリケーションと Kubernetes の世界では、モニタリングとオブザーバビリティはワークロードの信頼性、パフォーマンス、効率を確保するために非常に重要です。Amazon Elastic Kubernetes Service (EKS) は、コンテナ化されたアプリケーションをデプロイおよび管理するための強力でスケーラブルなプラットフォームを提供しており、Node Exporter、Amazon Managed Prometheus、Grafana などのツールと組み合わせることで、EKS ワークロードの包括的なモニタリングソリューションを実現できます。

Node Exporter は、ホストマシンからハードウェアやカーネル関連のさまざまなメトリクスを公開する Prometheus エクスポーターです。EKS クラスターに Node Exporter を DaemonSet としてデプロイすることで、CPU、メモリ、ディスク、ネットワーク使用量などの貴重なメトリクスを各ワーカーノードから収集できます。また、さまざまなシステムレベルのメトリクスも収集できます。

Amazon Managed Prometheus は、AWS が提供する完全マネージドサービスで、Prometheus モニタリングインフラストラクチャのデプロイ、管理、スケーリングを簡素化します。Node Exporter と Amazon Managed Prometheus を統合することで、ノードレベルのメトリクスを高可用性かつスケーラブルな方法で収集および保存できます。Prometheus インスタンスの管理やスケーリングのオーバーヘッドがありません。

Grafana は、Prometheus と緊密に統合された強力なオープンソースのデータ可視化およびモニタリングツールです。Grafana を Amazon Managed Prometheus インスタンスに接続するように構成すれば、EKS ワークロードと基盤となるインフラストラクチャの健全性とパフォーマンスをリアルタイムで把握できる、豊富でカスタマイズ可能なダッシュボードを作成できます。

![EKS AMP AMG](./images/eksnodeexporterampamg.png)
*図1: EKS ノードメトリクスを AMP に送信し、AMG で可視化*

このモニタリングスタックを EKS クラスターにデプロイすると、次のようなメリットがあります。

1. 包括的な可視性: Node Exporter からメトリクスを収集し、Grafana で可視化することで、アプリケーションレベルから基盤となるインフラストラクチャまで、EKS ワークロードの一貫したエンドツーエンドの可視性が得られます。これにより、問題を事前に特定して対処できます。

2. スケーラビリティと信頼性: Amazon Managed Prometheus と Grafana は、高いスケーラビリティと信頼性を備えているため、EKS ワークロードの規模が拡大しても、パフォーマンスや可用性を損なうことなく、モニタリングソリューションをシームレスに拡張できます。

3. 集中モニタリング: Amazon Managed Prometheus が集中モニタリングプラットフォームとして機能するため、複数の EKS クラスターからメトリクスを統合でき、異なる環境やリージョンにまたがるワークロードを監視および比較できます。

4. カスタムダッシュボードとアラート: Grafana の強力なダッシュボードとアラート機能を活用すれば、特定のモニタリングニーズに合わせてカスタマイズした可視化を作成でき、重要なイベントやしきい値に対するアラートを設定できます。

5. AWS サービスとの統合: Amazon Managed Prometheus は、Amazon CloudWatch や AWS X-Ray などの他の AWS サービスとシームレスに統合されるため、さまざまなソースからのメトリクスを統合モニタリングソリューション内で相関させて可視化できます。

この監視スタックを EKS クラスターに実装するには、次の一般的な手順に従う必要があります。

1. ノードレベルのメトリクスを収集するために、EKS ワーカーノードに Node Exporter を DaemonSet としてデプロイする。
2. Amazon Managed Prometheus ワークスペースを設定し、Node Exporter からメトリクスをスクレイピングするように構成する。
3. Grafana をインストールして構成する (EKS クラスター内か別のサービスとして)。そして、Amazon Managed Prometheus ワークスペースに接続する。
4. モニタリング要件に基づいて、カスタム Grafana ダッシュボードを作成し、アラートを設定する。

このモニタリングソリューションは強力な機能を提供しますが、Node Exporter、Prometheus、Grafana によってもたらされるオーバーヘッドとリソース消費を考慮する必要があります。モニタリングコンポーネントがアプリケーションワークロードとリソースを争わないよう、慎重な計画とリソース割り当てが必要です。

さらに、モニタリングソリューションがデータセキュリティ、アクセス制御、保持ポリシーのベストプラクティスに準拠していることを確認する必要があります。安全な通信チャネル、認証メカニズム、データ暗号化を実装することで、モニタリングデータの機密性と整合性を維持できます。

結論として、EKS クラスターに Node Exporter、Amazon Managed Prometheus、Grafana をデプロイすることで、コンテナ化されたワークロードの包括的なモニタリングソリューションが実現します。これらのツールを活用することで、アプリケーションのパフォーマンスと健全性に関する深い洞察が得られ、問題の事前検出、効率的なリソース活用、情報に基づく意思決定が可能になります。ただし、リソース消費、セキュリティ、コンプライアンス要件を考慮して、この監視スタックを慎重に計画および実装することが重要です。これにより、EKS ワークロードに対する効果的で堅牢なモニタリングソリューションを確保できます。
