# ハイブリッドとマルチクラウドのためのベストプラクティス

## はじめに

マルチクラウドとは、自社のワークロードを運用するために複数のクラウドサービスプロバイダーを同時に使用することを指します。ハイブリッドとは、オンプレミスとクラウドの両方の環境にわたってワークロードを拡張することです。ハイブリッドおよびマルチクラウド環境におけるオブザーバビリティは、ツールの多様性、レイテンシー、異種のワークロードにより、複雑性が大幅に増加する可能性があります。にもかかわらず、これは開発者とビジネスユーザーの両方にとって共通の目標であり続けています。製品とサービスの豊富なエコシステムがこれに対応しています。

ただし、クラウドネイティブなワークロードのためのオブザーバビリティツールの有用性は劇的に異なる可能性があります。 コンテナ化されたバッチ処理ワークロードを監視する要件と、サーバーレスフレームワークを使用したリアルタイムの銀行アプリケーションの要件を比較してみてください。両方にログ、メトリクス、トレースがあります。ただし、それらを観察するためのツールチェーンは異なり、多数のクラウドネイティブ、オープンソース、ISV製品が利用可能です。 Prometheusなどのオープンソースツールは、一方で非常に適している場合がありますが、マネージドサービスとして提供されるクラウドネイティブツールの方が要件をより満たす可能性があります。

これにマルチクラウドとハイブリッドの複雑さが加わると、アプリケーションからの洞察を取得することがかなり難しくなります。

これらの次元を追加し、オブザーバビリティへのアプローチを容易にするために、顧客は単一のツールチェーンへの投資に傾向があります。 結局のところ、信号対雑音比を下げることは通常、良いことです! ただし、単一のアプローチはすべてのユースケースには適していない上に、さまざまなプラットフォームの運用モデルが混乱を招く可能性があります。 私たちの目標は、問題が発生したときの対応時間を短縮するのに役立つ、ニーズに合った意思決定を支援することです。 以下は、あらゆる規模の顧客や業界全体での経験から学んだベストプラクティスです。

 !!! info
     これらのベストプラクティスは、エンタープライズアーキテクト、開発者、DevOpsなど、幅広い役割を対象としています。 分散環境におけるオブザーバビリティが、ビジネスニーズの観点から可能な限り多くの価値を提供できるよう、それらを評価することをお勧めします。

## ツールが判断を左右することがあってはならない

アプリケーション、ツール、プロセスは、売上や顧客満足度の向上などのビジネス目標を達成するための手段です。
賢明なテクノロジー戦略とは、これらのビジネス目標を達成するために可能な限りのことをする戦略です。
しかし、目標達成に役立つものは単なるツールであり、戦略を支えるためのものです - 戦略そのものではありません。
たとえば、家を建てる必要がある場合、ツールに設計や建設方法を尋ねることはありません。
むしろ、ツールは目的を達成するための手段なのです。

単一かつ同質の環境では、ツールの決定はより簡単です。
1つの環境で単一のアプリケーションを実行している場合、ツールを全体的に同じにすることができるからです。
しかし、ハイブリッドおよびマルチクラウド環境では状況は複雑で、これらの環境にわたるワークロードを観察することによる[付加価値](https://arxiv.org/abs/2303.13402)とビジネス目標を見失わないことが重要です。
各クラウドサービスプロバイダー(CSP)には独自のネイティブな可観測性ソリューションがあり、パートナーおよび独立系ソフトウェアベンダー(ISV)も豊富に揃っています。

複数の環境で運用しているからといって、すべてのワークロードに1つのツールを使用することが望ましいとは限りません。
これは、ワークロードを観察するために複数のサービス、フレームワーク、プロバイダを使用することを意味する可能性があります。
以下の「[シングルパネルはワークロードのコンテキストよりも重要ではない](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照して、運用モデルがニーズを反映する必要がある詳細を確認してください。
とにかく、ツールを実装する際は、将来的に可観測性ソリューションを進化させることができるように「[双方向ドア](https://aws.amazon.com/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/)」を作成することを忘れないでください。

ここでは、避けるべき「ツール優先」の結果の例を示します。

1. 将来的にアップグレードしたり、新しいソリューションに移行したりするための双方向ドアなしに、単一のツールの実装に焦点を当てることは、そうでなければ回避できた技術的負債を作り出す可能性があります。 ツールがソリューションであり、いつかは解決しなければならない問題になる場合があります。
2. ボリュームディスカウントにより、単一のツールを使用するという企業標準は、メリットを得られる機能がない結果となる可能性があります。 これは「コスト優先」であり、意図せずモノリシックなアンチパターンを作り出す可能性があります。 これは、ボリュームのしきい値以下にとどめるためにテレメトリの収集を阻害し、結果として可観測性ツールの使用を阻害する可能性があります。
3. 既存のトレース収集インフラがないが、豊富なログおよびメトリックコレクターがあるために、トレースの収集を行わないことは、不完全な可観測性ソリューションにつながる可能性があります。
4. 人件費とトレーニングコストを削減するために、単一のツールチェーンでのみトレーニングを受けたサポートスタッフは、他の可観測性パターンの潜在的な価値を低下させる可能性があります。

!!! success
    可観測性戦略をツールが左右している場合は、アプローチを逆転させる必要があります。 ツールは可観測性を可能にし、強化するためのものです。選択肢を制限するためではありません。
    
!!! success
    ツールの乱立は、企業が実際に苦しんでいる本物の問題です。しかし、単一のツールチェーンへの急激な移行は、同様に可観測性ソリューションの有用性を低下させる可能性があります。 ハイブリッドおよびマルチクラウドワークロードには、各プラットフォーム固有のテクノロジーがあり、各CSPの高レベルサービスは有用です。ただし、シングルソース製品を使用するトレードオフには、価値ベースの分析が必要です。 これらのリスクの一部を軽減するアプローチについては、「[OpenTelemetry に投資する](#invest-in-opentelemetry)」を参照してください。

## (オブザーバビリティ) データには重力がある

すべてのデータには重力があり、ワークロード、ソリューション、ツール、人、プロセス、プロジェクトなどを引き寄せる力があると言えます。たとえば、顧客の取引が記録されたデータベースは、コンピューティングや分析のワークロードを引き寄せる魅力的な力となります。これはワークロードの配置場所、環境、運用方法に直接影響します。同じことがオブザーバビリティ シグナルにも当てはまりますが、このデータが生み出す重力は、ワークロードと組織のコンテキストに結び付いています(「[シングルパネオブグラスよりもワークロードのコンテキストが重要](#a-single-pane-of-glass-is-less-important-than-your-workloads-context)」を参照)。

オブザーバビリティ テレメトリのコンテキストを、基礎となるワークロードや関連データから完全に切り離すことはできません。同じルールがここでも適用されます。テレメトリはデータであり、重力を持っています。これは、テレメトリ エージェント、コレクター、シグナルを集約および分析するシステムの配置場所に影響を与えるはずです。

!!! tip
    オブザーバビリティ データの時間経過とともにの価値は、他のデータ型よりもかなり低いです。オブザーバビリティ データの「半減期」と呼ぶことができます。テレメトリを別の環境に中継する際の追加のレイテンシを、使用前のこのデータの強制的な価値下落と見なし、それを問題が発生したときのアラート要件と比較検討してください。 

!!! success
    データのこの集約からビジネス上のメリットが得られる場合にのみ、環境間でデータを送信することがベスト プラクティスです。データのクエリに単一のソースを用意することは、それ自体で多くのビジネス ニーズを満たすものではなく、望ましくないほど高価なソリューションや、障害点を多く作り出す可能性があります。

## 1枚のガラスで全てを見渡すことより、ワークロードのコンテキストが重要

「1枚のガラス」で全てのワークロードを観測できることがよく要望されます。これは、できるだけシンプルな方法で、できるだけ多くのデータを表示したいという自然な欲求から生じています。また、こうしたアプローチによって、作業の負担や苛立ち、障害診断にかかる時間を削減できると考えられているためです。観測性ソリューション全体を一度に表示できる 1 つのインターフェイスを作成することは有用ですが、テレメトリデータを発生元のコンテキストから切り離すというトレードオフが伴う可能性があります。 

例えば、100台のサーバーのCPU利用率を示すダッシュボードが、消費量の異常なスパイクをいくつか表示していても、なぜこのようなことが発生したのか、あるいはこのような動作を招いた要因が何であるかはまったく説明されません。また、このメトリクスの重要性もすぐには明らかではありません。

1枚のガラスをあまりにも積極的に追求するあまり、顧客のビジネスコンテキストがすべて失われ、1つのツールで全てを見ようとすることが、実際にはそのデータの価値を希釈してしまうことがあります。ダッシュボードやツールは、[物語](/observability-best-practices/ja/tools/dashboards/)を伝える必要があります。そして、この物語には、ワークロード内のイベントに影響されるビジネスメトリクスやアウトカムも含める必要があります。

さらに、ツールは運用モデルに合わせる必要があります。グローバルなサポートチームが全環境にアクセスできる場合には、1枚のガラスが価値をもたらすことがありますが、単一のワークロードや単一のクラウドサービスプロバイダー環境、ハイブリッド環境にのみアクセスできる場合には、このアプローチから価値が生まれることはありません。このような場合、各環境内でネイティブにダッシュボードを作成できるようにすることで、時間を節約し、将来的な変更への柔軟性を高めることができます。

!!! success
    観測性データの価値は、発生源であるアプリケーションと深く統合されています。テレメトリには、その環境から得られるコンテキストの認識が必要です。ハイブリッド環境やマルチクラウド環境では、テクノロジー間の違いが大きいため、コンテキストの必要性はさらに高まります(ただし、Kubernetesなどのシステムは、クラウドプロバイダーやオンプレミス間で似通った構成をとることができます)。

!!! success
    分散システムの1枚のガラスを構築するときは、ビジネスメトリクスやサービスレベル目標(SLO)を、これらのSLOに影響を与える他のデータ(インフラストラクチャメトリクスなど)と同じビューに表示してください。これにより、コンテキストを欠くことがないようになります。


!!! tip
    1枚のガラスは、問題を迅速に診断し、検知までの時間(MTTD)を短縮することによって、解決までの平均時間(MTTR)を短縮するのに役立ちますが、テレメトリデータの意味を保持できる場合に限ります。これができない場合、1枚のガラスアプローチは時間の無駄になったり、運用チームにとってマイナスの影響を及ぼすことがあります。

!!! success
    1枚のガラスの価値が判断できない場合や、ワークロードが単一のクラウドサービスプロバイダーまたはオンプレミス環境に完全に縛られている場合は、上位レベルのビジネスメトリクスのみを1枚のガラスにロールアップし、生のメトリクスやその他の影響要因は元の環境に残すことを検討してください。

## OpenTelemetry への投資

オブザーバビリティ ベンダーのランドスケープ全体で、OpenTelemetry(OTel) はデファクトスタンダードとなっています。OTEL は各テレメトリ型を 1 つまたは複数の Collector にマーシャリングできます。これにはクラウドネイティブ サービスや、さまざまな SaaS および ISV 製品を含めることができます。OTel エージェントと Collector は、OpenTelemetry プロトコル(OTLP)を使用して通信します。これにより、さまざまなデプロイ パターンを可能にする形式でシグナルをカプセル化します。

最も価値のあるトランザクション トレースを収集し、ビジネスとインフラストラクチャのコンテキストを取得するには、アプリケーションにトレース収集を統合する必要があります。ほとんど労力を必要とせずにこれを実行できる自動インスツルメンテーション エージェントがあります。ただし、最も洗練されたユース ケースでは、トランザクション トレースをサポートするためにコード変更が必要です。これにより、技術的負債が発生し、ワークロードが特定のテクノロジに縛られます。 

OTel は、span のコンセプトを使用して、ログ、メトリクス、トレースをキャプチャします。Span には、単一のトランザクションからグループ化されたこれらのシグナルが含まれ、コンテキスト化された検索可能なオブジェクトにパッケージ化されます。これは、単一のアプリケーション イベントからのシグナルを 1 つのシンプルなエンティティで表示できることを意味します。たとえば、Web サイトにログインしているユーザーと、このユーザーが統合しているすべてのダウンストリーム サービスへのリクエストを、1 つの span として表示できます。

!!! tip
    OTel はアプリケーション トレースに限定されておらず、ログとメトリクスに広く使用されています。また、[多くの ISV 製品が現在、OTLP を直接受け入れています](https://opentelemetry.io/ecosystem/vendors/)。
    
!!! Success
    OTel を使用してアプリケーションにインスツルメンテーションを適用することで、将来的に 1 つのオブザーバビリティ プラットフォームから別のプラットフォームに移行する場合でも、このインスツルメンテーションをアプリケーション層で置き換える必要がなくなります。これにより、オブザーバビリティ ソリューションの一部が [two-way door](https://aws.amazon.com/executive-insights/content/how-amazon-defines-and-operationalizes-a-day-1-culture/) になります。
    
!!! success
   OTelは、将来の変更に対応可能でスケーラブルであり、アプリケーションコードを変更することなく、収集および分析システムを将来的に変更しやすくするため、効率的な [left shift](https://www.youtube.com/watch?v=99r7cxKW8Rg) です。
